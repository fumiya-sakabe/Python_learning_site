{% extends "base.html" %}

{% block title %}お気に入り - Python学習サイト{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1>お気に入り</h1>
        <p>後で読みたいレッスンやプロジェクトを保存しておけます</p>
    </div>
</div>

<section class="favorites-section">
    <div class="container">
        {% if favorite_lessons or favorite_projects %}
        {% if favorite_lessons %}
        <div class="favorites-group">
            <h2>レッスン</h2>
            <div class="lessons-grid">
                {% for lesson in favorite_lessons %}
                <div class="lesson-card">
                    <div class="lesson-header">
                        <div class="lesson-badge level-{{ lesson.get('level', '初級') }}">{{ lesson.get('level', '初級') }}</div>
                        <span class="lesson-number">{{ lesson.id }}</span>
                    </div>
                    <h3>{{ lesson.title }}</h3>
                    <button class="favorite-btn active" data-kind="lesson" data-id="{{ lesson.id }}" title="お気に入りから削除">
                        ⭐
                    </button>
                    <a href="{{ url_for('lesson_detail', lesson_id=lesson.id) }}" class="btn btn-primary btn-sm">詳細を見る</a>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if favorite_projects %}
        <div class="favorites-group">
            <h2>プロジェクト</h2>
            <div class="projects-grid">
                {% for project in favorite_projects %}
                <div class="project-card">
                    <h3>{{ project.title }}</h3>
                    <p class="project-description">{{ project.get('description', '説明がありません') }}</p>
                    <button class="favorite-btn active" data-kind="project" data-id="{{ project.id }}" title="お気に入りから削除">
                        ⭐
                    </button>
                    <a href="{{ url_for('project_detail', project_id=project.id) }}" class="btn btn-primary btn-sm">このレッスンを見る</a>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        {% else %}
        <div class="empty-state">
            <p>お気に入りはまだありません。</p>
            <p>レッスンやプロジェクトの⭐ボタンから追加できます。</p>
        </div>
        {% endif %}
    </div>
</section>

<script>
// お気に入りボタンの処理
document.querySelectorAll('.favorite-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const kind = this.dataset.kind;
        const id = this.dataset.id;
        
        try {
            const response = await fetch('/api/favorites/toggle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ item_id: id, kind: kind })
            });
            
            const data = await response.json();
            if (data.ok) {
                if (data.is_favorite) {
                    this.classList.add('active');
                } else {
                    this.classList.remove('active');
                    // お気に入り一覧ページの場合、カードを削除
                    if (window.location.pathname === '/favorites') {
                        this.closest('.lesson-card, .project-card')?.remove();
                        // グループが空になったら非表示
                        const group = this.closest('.favorites-group');
                        if (group && !group.querySelector('.lesson-card, .project-card')) {
                            group.remove();
                        }
                    }
                }
            }
        } catch (error) {
            console.error('お気に入りの更新に失敗しました:', error);
        }
    });
});
</script>
{% endblock %}
