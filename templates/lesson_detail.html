{% extends "base.html" %}

{% block title %}{{ lesson.title }} - Pythonå­¦ç¿’ã‚µã‚¤ãƒˆ{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/markdown.css') }}">
{% endblock %}

{% block content %}
<div class="lesson-detail-header">
    <div class="container">
        <a href="{{ url_for('lessons_list') }}" class="back-link">â† ãƒ¬ãƒƒã‚¹ãƒ³ä¸€è¦§ã«æˆ»ã‚‹</a>
        <div class="lesson-title-row">
            <h1>{{ lesson.title }}</h1>
            {% if current_user.is_authenticated %}
            <button class="favorite-btn {% if is_favorite %}active{% endif %}" 
                    data-kind="lesson" data-id="{{ lesson.id }}" 
                    title="ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ /å‰Šé™¤">
                â­
            </button>
            {% endif %}
        </div>
        <div class="lesson-meta">
            <span class="badge">{{ lesson.get('level', 'åˆç´š') }}</span>
            <span class="badge">{{ lesson.get('category', 'N/A') }}</span>
        </div>
    </div>
</div>

<section class="lesson-content">
    <div class="container">
        {% if current_user.is_authenticated %}
        <div class="progress-toggle">
            <button id="toggle-progress" class="btn {{ 'btn-secondary' if completed else 'btn-primary' }}">
                {{ 'å®Œäº†ã‚’å¤–ã™' if completed else 'ã“ã®ãƒ¬ãƒƒã‚¹ãƒ³ã‚’å®Œäº†ã«ã™ã‚‹' }}
            </button>
            <span id="progress-state" class="badge">{{ 'å®Œäº†' if completed else 'æœªå®Œäº†' }}</span>
        </div>
        
        <div class="lesson-note-section">
            <h3>ğŸ“ å­¦ç¿’ãƒãƒ¼ãƒˆ</h3>
            <textarea id="lesson-note" class="note-textarea" placeholder="ã“ã®ãƒ¬ãƒƒã‚¹ãƒ³ã«ã¤ã„ã¦ãƒ¡ãƒ¢ã‚’æ®‹ã›ã¾ã™...">{{ note }}</textarea>
            <button id="save-note" class="btn btn-primary btn-sm">ä¿å­˜</button>
            <span id="note-saved" class="note-saved-indicator" style="display: none;">ä¿å­˜ã—ã¾ã—ãŸ</span>
        </div>
        {% endif %}
        <div class="markdown-body">
            {{ content|safe }}
        </div>
    </div>
</section>

<nav class="lesson-navigation">
    <div class="container">
        <div class="lesson-nav-buttons">
            {% if prev_lesson %}
            <a href="{{ url_for('lesson_detail', lesson_id=prev_lesson['id']) }}" class="btn btn-secondary">
                â† {{ prev_lesson['title'] }}
            </a>
            {% else %}
            <span class="btn btn-secondary disabled">â† å‰ã®ãƒ¬ãƒƒã‚¹ãƒ³</span>
            {% endif %}
            
            <a href="{{ url_for('lessons_list') }}" class="btn btn-primary">ãƒ¬ãƒƒã‚¹ãƒ³ä¸€è¦§ã«æˆ»ã‚‹</a>
            
            {% if next_lesson %}
            <a href="{{ url_for('lesson_detail', lesson_id=next_lesson['id']) }}" class="btn btn-secondary">
                {{ next_lesson['title'] }} â†’
            </a>
            {% else %}
            <span class="btn btn-secondary disabled">æ¬¡ã®ãƒ¬ãƒƒã‚¹ãƒ³ â†’</span>
            {% endif %}
        </div>
    </div>
</nav>
{% if current_user.is_authenticated %}
<script>
document.getElementById('toggle-progress')?.addEventListener('click', async function () {
  const res = await fetch('{{ url_for("api_progress_toggle") }}', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ item_id: '{{ lesson.id }}', kind: 'lesson' })
  });
  if (!res.ok) return;
  const data = await res.json();
  const btn = document.getElementById('toggle-progress');
  const state = document.getElementById('progress-state');
  if (data.completed) {
    btn.classList.remove('btn-primary'); btn.classList.add('btn-secondary');
    btn.textContent = 'å®Œäº†ã‚’å¤–ã™';
    state.textContent = 'å®Œäº†';
  } else {
    btn.classList.remove('btn-secondary'); btn.classList.add('btn-primary');
    btn.textContent = 'ã“ã®ãƒ¬ãƒƒã‚¹ãƒ³ã‚’å®Œäº†ã«ã™ã‚‹';
    state.textContent = 'æœªå®Œäº†';
  }
});
</script>
{% endif %}

<script>
// ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³ã®å‡¦ç†
document.querySelectorAll('.favorite-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const kind = this.dataset.kind;
        const id = this.dataset.id;
        
        try {
            const response = await fetch('/api/favorites/toggle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ item_id: id, kind: kind })
            });
            
            const data = await response.json();
            if (data.ok) {
                if (data.is_favorite) {
                    this.classList.add('active');
                } else {
                    this.classList.remove('active');
                }
            }
        } catch (error) {
            console.error('ãŠæ°—ã«å…¥ã‚Šã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        }
    });
});
</script>
{% endblock %}

