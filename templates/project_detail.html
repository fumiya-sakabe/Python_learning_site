{% extends "base.html" %}

{% block title %}{{ project.title }} - ãƒŸãƒ‹ã‚¢ãƒ—ãƒªè©³ç´°{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/markdown.css') }}">
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <div class="project-title-row">
            <h1>{{ project.title }}</h1>
            {% if current_user.is_authenticated %}
            <button class="favorite-btn {% if is_favorite %}active{% endif %}" 
                    data-kind="project" data-id="{{ project.id }}" 
                    title="ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ /å‰Šé™¤">
                â­
            </button>
            {% endif %}
        </div>
        <p class="project-id">ID: {{ project.id }}</p>
    </div>
</div>

<section class="lesson-content">
    <div class="container">
        {% if current_user.is_authenticated %}
        <div class="progress-toggle">
            <button id="toggle-progress" class="btn {{ 'btn-secondary' if completed else 'btn-primary' }}">
                {{ 'å®Œäº†ã‚’å¤–ã™' if completed else 'ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å®Œäº†ã«ã™ã‚‹' }}
            </button>
            <span id="progress-state" class="badge">{{ 'å®Œäº†' if completed else 'æœªå®Œäº†' }}</span>
        </div>
        
        <div class="lesson-note-section">
            <h3>ğŸ“ å­¦ç¿’ãƒãƒ¼ãƒˆ</h3>
            <textarea id="lesson-note" class="note-textarea" placeholder="ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¤ã„ã¦ãƒ¡ãƒ¢ã‚’æ®‹ã›ã¾ã™...">{{ note }}</textarea>
            <button id="save-note" class="btn btn-primary btn-sm">ä¿å­˜</button>
            <span id="note-saved" class="note-saved-indicator" style="display: none;">ä¿å­˜ã—ã¾ã—ãŸ</span>
        </div>
        {% endif %}
        <div class="markdown-body">
            {{ content|safe }}
        </div>
    </div>
</section>

<nav class="lesson-navigation">
    <div class="container">
        <div class="lesson-nav-buttons">
            {% if prev_project %}
            <a href="{{ url_for('project_detail', project_id=prev_project['id']) }}" class="btn btn-secondary">
                â† {{ prev_project['title'] }}
            </a>
            {% else %}
            <span class="btn btn-secondary disabled">â† å‰ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</span>
            {% endif %}

            <a href="{{ url_for('phase2') }}" class="btn btn-primary">Phase2ã«æˆ»ã‚‹</a>
            <a href="{{ url_for('projects_list') }}" class="btn btn-primary">ä¸€è¦§ã«æˆ»ã‚‹</a>

            {% if next_project %}
            <a href="{{ url_for('project_detail', project_id=next_project['id']) }}" class="btn btn-secondary">
                {{ next_project['title'] }} â†’
            </a>
            {% else %}
            <span class="btn btn-secondary disabled">æ¬¡ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ â†’</span>
            {% endif %}
        </div>
    </div>
</nav>
{% if current_user.is_authenticated %}
<script>
document.getElementById('toggle-progress')?.addEventListener('click', async function () {
  const res = await fetch('{{ url_for("api_progress_toggle") }}', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ item_id: '{{ project.id }}', kind: 'project' })
  });
  if (!res.ok) return;
  const data = await res.json();
  const btn = document.getElementById('toggle-progress');
  const state = document.getElementById('progress-state');
  if (data.completed) {
    btn.classList.remove('btn-primary'); btn.classList.add('btn-secondary');
    btn.textContent = 'å®Œäº†ã‚’å¤–ã™';
    state.textContent = 'å®Œäº†';
  } else {
    btn.classList.remove('btn-secondary'); btn.classList.add('btn-primary');
    btn.textContent = 'ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å®Œäº†ã«ã™ã‚‹';
    state.textContent = 'æœªå®Œäº†';
  }
});
</script>
{% endif %}

<script>
// ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³ã®å‡¦ç†
document.querySelectorAll('.favorite-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const kind = this.dataset.kind;
        const id = this.dataset.id;
        
        try {
            const response = await fetch('/api/favorites/toggle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ item_id: id, kind: kind })
            });
            
            const data = await response.json();
            if (data.ok) {
                if (data.is_favorite) {
                    this.classList.add('active');
                } else {
                    this.classList.remove('active');
                }
            }
        } catch (error) {
            console.error('ãŠæ°—ã«å…¥ã‚Šã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        }
    });
});
</script>

<script>
// ãƒãƒ¼ãƒˆä¿å­˜ã®å‡¦ç†
document.addEventListener('DOMContentLoaded', function() {
    const saveNoteBtn = document.getElementById('save-note');
    const noteTextarea = document.getElementById('lesson-note');
    const noteSaved = document.getElementById('note-saved');
    
    if (saveNoteBtn && noteTextarea) {
        saveNoteBtn.addEventListener('click', async function() {
            const note = noteTextarea.value.trim();
            
            try {
                const response = await fetch('/api/notes/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        item_id: '{{ project.id }}', 
                        kind: 'project',
                        note: note 
                    })
                });
                
                const data = await response.json();
                if (data.ok) {
                    noteSaved.style.display = 'inline';
                    setTimeout(() => {
                        noteSaved.style.display = 'none';
                    }, 2000);
                }
            } catch (error) {
                console.error('ãƒãƒ¼ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                alert('ãƒãƒ¼ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });
    }
});
</script>
{% endblock %}


